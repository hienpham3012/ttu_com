function mark(e,i){var o=new paper.Path.RegularPolygon(new paper.Point(e,i),3,5);return o.fillColor="yellow",o.strokeColor="red",o.opacity=.5,o}var HoneycombController=function(e,i){var o=this;o.resize=_.debounce(_.bind(o._resize,o),50),o.items=[],o.props={},HoneycombController.super_.apply(o,arguments)};utils.inherits(HoneycombController,SimpleAppProto),HoneycombController.prototype.createDom=function(e){var i=this,o=i.getViewportSize();i.canvas=document.createElement("canvas"),i.canvas.width=o.width,i.canvas.height=o.height,i.canvas.setAttribute("hidpi","off"),i.quality=(e||{}).quality||{};var t=Math.ceil(window.screen.width/(i.props.numOfColumns+.5));_.each(i.items,function(e,o){var r=e.width/t;e.canvasURI=utils.getResizedImageUrl(e.uri,t,Math.ceil(e.height/r),{siteQuality:i.quality,maxWidth:e.width,maxHeight:e.height})}),i.el.append(i.canvas),paper.setup(i.canvas),paper.project.activeLayer.remove()},HoneycombController.prototype.calcViewportOffset=function(){return this.shapeSideMargin()},HoneycombController.prototype.gridOutline=function(e){for(var i=this,o=i.outlineLayer(),t=i.gridCellDim(i.sides),r=new paper.CompoundPath({children:[new paper.Path.Rectangle([0,0],[.1,.1])]}),a=[],s=0;s<i.layout.length;s++){var l,n=i.layout[s],p=n.rotated,d=n.position,h=s==i.items.length-1;if(6==i.sides&&(l=new paper.Path.RegularPolygon(d,6,t.radius)),4==i.sides&&(l=new paper.Path.RegularPolygon(d,4,t.radius),l.rotate(45)),3==i.sides&&(l=new paper.Path.RegularPolygon(d,3,t.radius),l.rotate(p?90:-90)),l.invertedShape=n.rotated,drill=l.clone(),l.scale(n.outlineScaleFactor),l.position=d,drill.position=d,n.outlineCorrection&&(l.position.x+=n.outlineCorrection),l.isGridCell=!0,r.addChild(l),3==i.sides&&h&&i.items.length%i.props.numOfColumns!=0)if(n.rotated){var c=s-(i.props.numOfColumns-1),u=i.layout[c],y=l.clone(!1);y.position=u.position,y.isTrailCell=!0,y.position.y+=i.props.margin*Math.sqrt(3)/(0==n.col?3:2),a.push(y)}else{var y=l.clone(!1);y.rotate(180),y.position.x=l.bounds.center.x+l.bounds.width,y.position.y=l.position.y;var v=new paper.Path.Rectangle([y.bounds.topLeft.x+i.props.margin/2,0],y.bounds.bottomRight),C=y.subtract(v);v.remove(),y.remove(),C.isTrailCell=!0,a.push(C)}}a.length&&r.addChildren(a),r.fillColor=i.props.holesColor,r.fillColor.alpha=i.props.alphaHolesColor,o.addChild(r)},HoneycombController.prototype.gridCellDim=function(e){var i,o,t,r,a,s,l=this,n=l.getViewportSize().width-l.shapeSideMargin()*(l.props.numOfColumns+1);switch(e){case 6:n-=.5*l.shapeSideMargin(),i=n/this.props.numOfColumns,t=i/Math.sqrt(3),o=2*t,r=t,a=i,s=o;break;case 3:i=n/this.props.numOfColumns,r=2*i/Math.sqrt(3),o=Math.sqrt(3)*r/2,t=r/Math.sqrt(3),s=r,a=o;break;case 4:t=n/this.props.numOfColumns/2,o=r=i=t/Math.sqrt(2),s=a=2*t;break;default:t=n/this.props.numOfColumns,s=a=2*t}return{height:i,width:o,radius:t,side:r,bounds:{width:a,height:s}}},HoneycombController.prototype.serviceLayer=function(){return this._serviceLayer||(this._serviceLayer=new paper.Layer,this._serviceLayer.visible=!1),this._serviceLayer.nam="service",this._serviceLayer},HoneycombController.prototype.gridLayer=function(){return this._gridLayer||(this._gridLayer=new paper.Layer),this._gridLayer.nam="grid",this._gridLayer},HoneycombController.prototype.displayLayer=function(){var e=this,i=e.props.alphaBackgroundMouseoverColor;return e._displayLayer||(e._displayLayer=new paper.Layer({}),e._displayLayer.addChild(new paper.Shape.Rectangle(paper.view.bounds.topLeft,paper.view.bounds.bottomRight)),e._displayLayer.firstChild.fillColor="red",e._displayLayer.firstChild.fillColor.alpha=0,e._displayLayer.onClick=function(i){for(var o=i.point,t=_.rest(e._displayLayer.children),r=0;r<t.length;r++)if(t[r].contains(o))return e.itemClick(e.items[r],r,{},i)},e._displayLayer.onFrame=function(o){var t;e.activeShape?e.activeShape.fillColor||(e.activeShape.fillColor=e.props.backgroundMouseoverColor,e.activeShape.fillColor.alpha=0):e.prevActiveShape&&(t=o.time-void 0,e.prevActiveShape.fillColor=e.props.backgroundMouseoverColor,e.prevActiveShape.fillColor.alpha=Math.max(i-i*(t/.2),0))},e._displayLayer.onMouseMove=function(i){for(var o=i.point,t=!1,r=e._displayLayer.children,a=1;a<r.length;a++){var s=r[a];s.visible&&s.contains(o)?(e.activeShape=s,e.activeShape.fillColor=e.props.backgroundMouseoverColor,e.activeShape.fillColor.alpha=e.props.alphaBackgroundMouseoverColor,t=!0,e.activeShape&&e.activeShape!==s&&(e.activeShape.fillColor=e.props.backgroundMouseoverColor,e.activeShape.fillColor.alpha=0),e.activeShape=s,"disabled"!=e.props.galleryImageOnClickAction&&e.el.addClass("in-shape")):(s.fillColor=e.props.backgroundMouseoverColor,s.fillColor.alpha=0)}t||(e.activeShape=null,e.el.removeClass("in-shape"))}),e._displayLayer.firstChild.onitve=e._displayLayer.onMouseMove,e._displayLayer},HoneycombController.prototype.outlineLayer=function(){var e=this;return e._outlineLayer||(e._outlineLayer=new paper.Layer),e._outlineLayer},HoneycombController.prototype.createCellShape=function(e){var i=new paper.Path.RegularPolygon({x:-1e4,y:-1e4},this.sides,e.radius);switch(this.serviceLayer().addChild(i),this.sides){case 6:i.rotate(0);break;case 3:i.rotate(-90);break;case 4:i.rotate(45)}return i},HoneycombController.prototype.calcGrid=function(){var e=this,i=(e.outlineLayer(),e.gridLayer()),o=e.gridCellDim(e.sides),t=e.createCellShape(o);e.cells=e.drawGrid(i,t),e.gridOutline(e.cells),e.serviceLayer().visible=!1,paper.view.draw()},HoneycombController.prototype.updateCanvasSize=function(){var e=this,i=e.gridCellDim(e.sides),o=i.radius,t=e.shapeSideMargin(),r=e.items.length,a=e.props.numOfColumns,s=e.getViewportSize(),l={height:e.canvas.height,width:s.width,oldHeight:e.canvas.height,oldWidth:e.canvas.width,cols:a,rows:Math.ceil(r/a)};switch(3!=e.sides&&(r+=Math.ceil(r/a/2),l.rows=Math.ceil(r/a)),e.sides){case 6:l.height=(1.5*o+t)*l.rows+o/2;break;case 3:l.height=(i.bounds.height+2*t)*(l.rows/2+.5);break;case 4:l.height=(i.bounds.height+t)*(l.rows/2+.5)}return l.height+=2*e.shapeSideMargin(),e.canvas.height=l.height,e.canvas.width=l.width,paper.view&&(paper.view.viewSize=[l.width,l.height]),Wix.setHeight(l.height),l},HoneycombController.prototype.shapeSideMargin=function(){var e=this.props.margin;switch(this.sides){case 3:return e;case 4:return e*Math.sqrt(2);case 6:return e}},HoneycombController.prototype.calculateGridLayout=function(e,i){for(var o,t,r=this,a=[],s=r.gridCellDim(r.sides),l=s.bounds.width,n=s.bounds.height,p=r.shapeSideMargin(),d=n,h=l,c=r.calcViewportOffset(),u=0,y=r.items.length,v=0;v<i&&!(u>=y);v++)for(var C=v%2==0,m=0;m<e&&!(u>=y);m++){var f,g,w,b=m%2==0,L=!1;if(3==r.sides||C||m!=e-1){switch(r.sides){case 6:f=h/2+(h+p)*m,C||(f+=(h+p)/2),g=2+s.bounds.height/2+(d+p-(h+p)/Math.sqrt(3)/2)*v,t=(s.radius+p)/s.radius;break;case 3:f=h/2+(h+p)*m,g=(d+2*p)/2+(d/2+p)*v,(b&&!C||!b&&C)&&(L=!0),L&&0==m||!L&&m==r.props.numOfColumns-1?(t=(s.bounds.width+3*p)/s.bounds.width,o=L?.25*p:.25*-p):(t=(s.bounds.width+2.5*p)/s.bounds.width,o=L?.75*p:.75*-p);break;case 4:f=s.radius+(h+p)*m,C||(f+=(h+p)/2),g=s.radius+(d+p)/2*v,t=(s.radius+p)/s.radius}w={x:f+c,y:g+c},a.push({scaleFactor:1,outlineScaleFactor:t,outlineCorrection:o,position:w,rotated:L,row:v,col:m,dim:s,isEmpty:u>=y}),u++}else i++}return r.layout=a,a},HoneycombController.prototype.scaleOutline=function(){},HoneycombController.prototype.scaleGrid=function(){var e,i=this,o=i.updateCanvasSize(),t=i.calculateGridLayout(o.cols,o.rows),r=i.outlineLayer(),a=i.displayLayer(),s=_.rest(a.children);null==r.firstChild.children&&this.updateLayout(),e=r.firstChild.children,_.each(t,function(o,t){var r=i.cells[t],a=r.firstChild;a.position=o.position;var l=a.nextSibling,n=l.firstChild,p=l.lastChild,d=o.dim.bounds.width/a.bounds.width;a.scale(d),n.fitBounds(a.bounds),s[t]&&(s[t].scale(d,o.position),s[t].position=o.position),e[t+1].fitBounds(a.bounds),e[t+1].position=o.position,e[t+1].scale(o.outlineScaleFactor),o.outlineCorrection&&(e[t+1].position.x+=o.outlineCorrection),p.fitBounds(a.bounds,!0)});var l=e[e.length-1];if(3==i.sides&&l.isTrailCell){var n=t[t.length-1];if(n.rotated){var p=i.cells[i.cells.length-i.props.numOfColumns].firstChild;l.fitBounds(p.bounds),l.position=p.position,l.scale(n.outlineScaleFactor),l.position.y+=i.props.margin*Math.sqrt(3)/(0==n.col?3:2)}else{var p=e[e.length-2],d=p.clone(!1);d.rotate(180),d.position.x=p.position.x+p.bounds.width,d.position.y=p.position.y;var h=new paper.Path.Rectangle([d.bounds.topLeft.x+i.props.margin/2,0],d.bounds.bottomRight),c=d.subtract(h);h.remove(),c.isTrailCell=!0,l.parent.addChild(c),l.remove()}}paper.view.draw()},HoneycombController.prototype.drawGrid=function(e,i){var o=this,t=[],r=o.updateCanvasSize();Wix.setHeight(r.height);var a=o.calculateGridLayout(r.cols,r.rows);return _.each(a,function(e,o){var r=i.clone(),a=new paper.Group([r]);e.rotated&&(r.rotate(-180),r.invertedShape=!0),r.position=e.position;var s=r.clone(!1).scale(e.scaleFactor),l=new paper.Raster,n=new paper.Group([s,l]);r.fillColor="white",r.fillColor.alpha=.4,l.visible=!1,l.onLoad=function(){r.fillColor="transparent",r.fillColor.alpha=0,this.fitBounds(r.bounds,!0),this.visible=!0},n.clipped=!0,a.addChild(n),t.push(a)}),e.addChildren(t),t},HoneycombController.prototype.fillShapes=function(e,i){var o=this,t=-1,r=e.length,a=!1,s=function(){a||0==r&&_.isFunction(i)&&(i(),a=!0)};_.each(e,function(e,i){if(e){var a,l=e.children[1],n=l.lastChild,p=e.firstChild;if(!l)return void r--;if(t++,!(a=o.items[t]))return void r--;n.source!=a.canvasURI?n.source=a.canvasURI:(n.fitBounds(e.bounds),r--),n.onLoad=function(){r--,this.fitBounds(p.bounds,!0),s()}}}),s(),$("#viewport").on("mouseout",function(){var e=o.activeShape;e&&(o.activeShape=null,e.fillColor=o.props.backgroundMouseoverColor,e.fillColor.alpha=0,paper.view.draw())})},HoneycombController.prototype.updateLayout=function(){var e=this,i=e.displayLayer(),o=e.getViewportSize();e.inUpdate||(e.inUpdate=!0,e.canvas.width=o.width,e.cells?1==i.children.length&&_.each(e.cells,function(o,t){if(!e.layout[t].isEmpty){var r=o.firstChild.clone(!1);r.fillColor.alpha=0,i.addChild(r)}}):e.calcGrid(),e.fillShapes(e.cells,function(){e.inUpdate=!1}))},HoneycombController.prototype.destroy=function(e){var i=this;delete i._serviceLayer,delete i._gridLayer,delete i.cells,delete i._outlineLayer,i._displayLayer&&(i._displayLayer.onFrame=null,i._displayLayer.onClick=null,i._displayLayer.onMouseMove=null,delete i._displayLayer),paper&&paper.project&&paper.view&&(paper.project.clear(),paper.view.draw()),!1!==e&&i.el.html("")},HoneycombController.prototype.updateSettings=function(e){var i=this;if(i.mainPageId=e.mainPageId,e&&e.items&&e.props){var o=["imageShape","numOfColumns"],t=!i.props||!i.props.imageShape||i.propsChanged(e.props,o)||i.didItemsChange(i.items,e.items);if(!t&&i.itemsChanged(e.items,[])&&(t=!0),utils.isEqualQuality(i.quality,e.quality)||(t=!0,i.quality=e.quality),t){switch(i.destroy(),i.props=e.props||{},i.items=e.items||[],i.props.imageShape.toLowerCase()){case"hexagon":i.sides=6;break;case"triangle":i.sides=3;break;case"square":i.sides=4;break;default:i.sides=4}i.createDom(),i.calcGrid(),i.updateLayout()}else{_.extend(i.props,e.props);for(var r=0;r<this.items.length;r++)_.extend(i.items[r],e.items[r]);i.outlineLayer().fillColor=i.props.holesColor,i.outlineLayer().fillColor.alpha=i.props.alphaHolesColor,i.scaleGrid()}}},HoneycombController.prototype._resize=function(){var e=this,i=e.getViewportSize(),o=e.props.numOfColumns*(20+e.props.margin);if(i.width<o)return Wix.setHeight(o);paper.view&&(paper.view.viewSize=[e.canvas.width,e.canvas.height]),!0!==e.inUpdate&&(e.scaleGrid(),e.scaleOutline())},HoneycombController.prototype.scaleDisplay=function(){var e=this,i=this.getViewportSize(),o=i.width/e.canvas.width;paper.view.viewSize=[e.canvas.width*o,e.canvas.height*o],e.el.height(paper.view.viewSize.height).width(paper.view.viewSize.width)},HoneycombController.prototype._reset=_.debounce(function(){this.destroy(!1),paper.setup(this.canvas),this.updateLayout()},500),HoneycombController.prototype.itemClick=function(e,i,o,t){switch(this.props.galleryImageOnClickAction){default:case"zoomMode":Wix.pushState(JSON.stringify({cmd:"zoom",args:[i]}));break;case"disabled":Wix.pushState(JSON.stringify({cmd:"itemClicked",args:[i]}));break;case"goToLink":this.openLink(e.href,e.target,e.linkType,t,e["data-anchor"],this.mainPageId,e.link)}return!1},HoneycombController.prototype.getViewportSize=function(){var e=document.documentElement;return{width:e.clientWidth,height:e.clientHeight}},HoneycombController.prototype.didItemsChange=function(e,i){var o=_.pluck(e,"id"),t=_.pluck(i,"id"),r=!_.every(o,function(e,i){return t[i]===e}),a=_.pluck(e,"uri"),s=_.pluck(i,"uri"),l=!_.every(a,function(e,i){return s[i]===e});return r||l};